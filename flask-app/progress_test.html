<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Progress Test - レンダリング進行状況テスト</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; 
      background: #1e1e1e; 
      color: #e2e2e2; 
      margin: 24px; 
    }
    .card { 
      background: #2b2b2b; 
      border-radius: 8px; 
      padding: 16px; 
      max-width: 720px; 
      margin-bottom: 16px;
    }
    label { display: block; margin: 8px 0 4px; }
    input[type="text"] { 
      width: 100%; 
      padding: 8px; 
      border-radius: 4px; 
      border: 1px solid #444; 
      background: #1a1a1a; 
      color: #e2e2e2; 
    }
    button { 
      margin-top: 12px; 
      background: #175C76; 
      color: #e2e2e2; 
      border: 0; 
      padding: 10px 14px; 
      border-radius: 6px; 
      cursor: pointer; 
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #333;
      border-radius: 10px;
      overflow: hidden;
      margin: 8px 0;
    }
    .progress-fill {
      height: 100%;
      background-color: #4CAF50;
      transition: width 0.3s ease;
      width: 0%;
    }
    .status {
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
    }
    .status.running { background-color: #2196F3; }
    .status.done { background-color: #4CAF50; }
    .status.error { background-color: #f44336; }
    pre { 
      background: #111; 
      padding: 12px; 
      border-radius: 6px; 
      overflow: auto; 
      white-space: pre-wrap;
    }
  </style>
  <script>
    let pollingInterval = null;
    let currentUniqueId = null;

    async function startPolling() {
      const uniqueIdInput = document.getElementById('uniqueId');
      const log = document.getElementById('log');
      const statusDiv = document.getElementById('status');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      const btnStart = document.getElementById('btnStart');
      const btnStop = document.getElementById('btnStop');

      const uniqueId = uniqueIdInput.value.trim();
      if (!uniqueId) {
        log.textContent = 'ユニークIDを入力してください。';
        return;
      }

      currentUniqueId = uniqueId;
      btnStart.disabled = true;
      btnStop.disabled = false;
      log.textContent = `ポーリング開始: ${uniqueId}\n`;

      // 即座に1回チェック
      await checkStatus();

      // 1秒ごとにポーリング
      pollingInterval = setInterval(checkStatus, 1000);

      async function checkStatus() {
        try {
          const baseUrl = document.getElementById('serverUrl').value.replace('/upload', '');
          const res = await fetch(`${baseUrl}/status/${uniqueId}`);
          const data = await res.json();

          if (data.status === 'error') {
            log.textContent += `エラー: ${data.message}\n`;
            stopPolling();
            return;
          }

          const status = data.status;
          const progress = data.progress || 0;
          const current = data.current || 0;
          const total = data.total || 1;

          // ステータス表示
          statusDiv.className = `status ${status}`;
          statusDiv.textContent = `ステータス: ${status.toUpperCase()}`;

          // プログレスバー更新
          progressFill.style.width = `${progress}%`;
          progressText.textContent = `${progress}% (${current}/${total})`;

          // ログに追加
          log.textContent += `[${new Date().toLocaleTimeString()}] ${status}: ${progress}% (${current}/${total})\n`;
          log.scrollTop = log.scrollHeight;

          // 完了またはエラーの場合はポーリング停止
          if (status === 'done' || status === 'error') {
            stopPolling();
            if (status === 'done') {
              log.textContent += `\n✅ レンダリング完了！\n`;
              log.textContent += `ダウンロード: ${baseUrl}/download/${uniqueId}\n`;
            } else {
              log.textContent += `\n❌ レンダリングエラー\n`;
            }
          }

        } catch (err) {
          log.textContent += `ポーリングエラー: ${err}\n`;
        }
      }
    }

    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
      document.getElementById('btnStart').disabled = false;
      document.getElementById('btnStop').disabled = true;
    }

    function clearLog() {
      document.getElementById('log').textContent = '';
    }

    // クエリパラメータ ?id=... を読んで自動入力・自動開始
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (id) {
        const input = document.getElementById('uniqueId');
        input.value = id;
        startPolling();
      }
    });
  </script>
</head>
<body>
  <div class="card">
    <h2>Progress Test</h2>
    <p>レンダリングの進行状況をポーリングで確認します。</p>

    <label for="serverUrl">サーバURL</label>
    <input id="serverUrl" type="text" value="http://wkimono.home:5000/upload" />

    <label for="uniqueId">ユニークID</label>
    <input id="uniqueId" type="text" placeholder="例: aB3dE7fG9hJ2kL5mN" />

    <button id="btnStart" onclick="startPolling()">ポーリング開始</button>
    <button id="btnStop" onclick="stopPolling()" disabled>ポーリング停止</button>
    <button onclick="clearLog()">ログクリア</button>

    <div id="status" class="status running" style="display: none;">ステータス: 待機中</div>
    
    <div class="progress-bar">
      <div id="progressFill" class="progress-fill"></div>
    </div>
    <div id="progressText">0% (0/1)</div>

    <h3>ログ</h3>
    <pre id="log"></pre>
  </div>

  <div class="card">
    <h3>使用方法</h3>
    <ol>
      <li>まず <a href="/upload_test" target="_blank">アップロードテスト</a> でファイルをアップロード</li>
      <li>アップロード成功時に返されるユニークIDをコピー</li>
      <li>このページでユニークIDを入力してポーリング開始</li>
      <li>レンダリングの進行状況がリアルタイムで表示されます</li>
    </ol>
  </div>
</body>
</html>
